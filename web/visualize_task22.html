<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ИЗ №22 — Визуализация интеграла</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,.1); }
    h1, h2 { text-align: center; color: #333; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-bottom: 10px; }
    .chart { position: relative; height: 420px; margin: 24px 0; }
    .summary { background: #e8f4fd; border-left: 4px solid #2196F3; padding: 12px 16px; border-radius: 6px; margin: 18px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th{ background:#f2f2f2; }
    .muted{ color:#666; }
  </style>
</head>
<body>
<div class="container">
  <h1>Индивидуальное задание №22</h1>
  <div class="summary">
    <b>Интеграл:</b> \( \int_{0}^{1} \frac{e^x}{1+e^x}\,dx \) &nbsp;=&nbsp; \(\ln(1+e)-\ln 2\) ≈ <span id="exactVal">0.6190612867</span><br>
    <span class="muted">Поддерживаются CSV из твоей программы с заголовком:<br>
      <code>n;Trapezoid;Simpson;Exact;absErr(Trap);absErr(Simpson)</code>
    </span>
  </div>

  <div class="controls">
    <input type="file" id="fileInput" accept=".csv" />
    <button id="demoBtn">Загрузить пример</button>
  </div>

  <div class="grid">
    <div class="chart">
      <canvas id="valuesChart"></canvas>
    </div>
    <div class="chart">
      <canvas id="errorsChart"></canvas>
    </div>
  </div>

  <h2>Таблица данных</h2>
  <div class="chart" style="height:auto; min-height:unset;">
    <table id="dataTable">
      <thead>
        <tr>
          <th>n</th>
          <th>Trapezoid</th>
          <th>Simpson</th>
          <th>Exact</th>
          <th>|Err(Trap)|</th>
          <th>|Err(Simpson)|</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="muted">Подсказка: чтобы всегда получать CSV автоматически, можешь писать файл <code>result22.csv</code> из программы, а потом загрузить его здесь.</p>
  </div>
</div>

<script>
  // --- графики ---
  const valuesCtx = document.getElementById('valuesChart').getContext('2d');
  const errorsCtx = document.getElementById('errorsChart').getContext('2d');

  let valuesChart = new Chart(valuesCtx, {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'Trapezoid', data: [], borderWidth: 2, fill:false },
      { label: 'Simpson',   data: [], borderWidth: 2, fill:false },
      { label: 'Exact',     data: [], borderWidth: 2, borderDash:[6,6], fill:false }
    ]},
    options: {
      responsive:true, maintainAspectRatio:false,
      scales: {
        x: { title:{display:true, text:'n'} },
        y: { title:{display:true, text:'Значение интеграла'} }
      }
    }
  });

  let errorsChart = new Chart(errorsCtx, {
    type: 'line',
    data: { labels: [], datasets: [
      { label: '|Err(Trap)|', data: [], borderWidth: 2, fill:false },
      { label: '|Err(Simpson)|', data: [], borderWidth: 2, fill:false }
    ]},
    options: {
      responsive:true, maintainAspectRatio:false,
      scales: {
        x: { title:{display:true, text:'n'} },
        y: { type:'logarithmic', title:{display:true, text:'Абсолютная погрешность (log)'},
             ticks:{ callback: (v) => Number(v).toExponential() } }
      }
    }
  });

  // --- парсер семиколонного CSV ---
  function parseCSV(text){
    // ожидаем заголовок n;Trapezoid;Simpson;Exact;absErr(Trap);absErr(Simpson)
    const lines = text.trim().split(/\r?\n/);
    // убираем строку заголовка, если она есть
    const header = lines[0].toLowerCase();
    let start = 0;
    if (header.includes('trapezoid') || header.includes('simpson')) start = 1;

    const rows = [];
    for (let i = start; i < lines.length; i++){
      const cells = lines[i].split(';').map(s => s.trim());
      if (cells.length < 6) continue;
      const row = {
        n: +cells[0],
        trap: +cells[1],
        simp: +cells[2],
        exact: +cells[3],
        errT: +cells[4],
        errS: +cells[5]
      };
      if (!isFinite(row.n)) continue;
      rows.push(row);
    }
    return rows;
  }

  function updateTable(rows){
    const tb = document.querySelector('#dataTable tbody');
    tb.innerHTML = '';
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.n}</td>
        <td>${r.trap.toFixed(12)}</td>
        <td>${r.simp.toFixed(12)}</td>
        <td>${r.exact.toFixed(12)}</td>
        <td>${r.errT.toExponential(6)}</td>
        <td>${r.errS.toExponential(6)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function updateCharts(rows){
    const labels = rows.map(r => r.n);
    valuesChart.data.labels = labels;
    valuesChart.data.datasets[0].data = rows.map(r => r.trap);
    valuesChart.data.datasets[1].data = rows.map(r => r.simp);
    valuesChart.data.datasets[2].data = rows.map(r => r.exact);
    valuesChart.update();

    errorsChart.data.labels = labels;
    errorsChart.data.datasets[0].data = rows.map(r => Math.max(r.errT, 1e-20));
    errorsChart.data.datasets[1].data = rows.map(r => Math.max(r.errS, 1e-20));
    errorsChart.update();
  }

  async function handleFile(file){
    const text = await file.text();
    const rows = parseCSV(text);
    if (!rows.length){ alert('Не удалось распарсить CSV'); return; }
    // обновим "точное" значение из первой строки
    document.getElementById('exactVal').textContent = rows[0].exact.toFixed(10);
    updateTable(rows);
    updateCharts(rows);
  }

  // Загрузка CSV пользователем
  document.getElementById('fileInput').addEventListener('change', (e) => {
    const file = e.target.files?.[0]; if (file) handleFile(file);
  });

  // Демо-данные (на случай, если CSV ещё нет)
  document.getElementById('demoBtn').addEventListener('click', () => {
    const demo = `n;Trapezoid;Simpson;Exact;absErr(Trap);absErr(Simpson)
10;0.619060473258;0.619061286757;0.619061286738;8.13480e-07;1.92e-11
1000;0.619061286737;0.619061286738;0.619061286738;6.10e-13;1.89e-16
100000;0.619061286738;0.619061286738;0.619061286738;2.22e-16;0.00e+00
1000000;0.619061286738;0.619061286738;0.619061286738;0.00e+00;0.00e+00`;
    const rows = parseCSV(demo);
    document.getElementById('exactVal').textContent = rows[0].exact.toFixed(10);
    updateTable(rows);
    updateCharts(rows);
  });
</script>
</body>
</html>